<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>タスク編集 - Todo管理</title>
    <link rel="stylesheet" href="../static/style.css">
</head>
<body>
    <div class="container">
        <div class="main-card">
            <!-- ===== ヘッダー ===== -->
            <div class="header-section">
                <div class="header-left">
                    <h1>✏️ タスク編集</h1>
                </div>
                <div class="header-right">
                    <button id="darkModeToggle" onclick="toggleDarkMode()" class="header-button">🌙 ダーク</button>
                    <a href="{{ url_for('home') }}" class="header-button">← 戻る</a>
                </div>
            </div>

            <!-- ===== メインコンテンツ ===== -->
            <div class="main-content">
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                    <div class="flashes">
                        {% for message in messages %}
                        <div class="flash-message">{{ message }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                {% endwith %}

                <div class="add-form">
                    <form method="POST" action="/edit/{{ todo.id }}">
                        <!-- タスク名 -->
                        <div class="form-row">
                            <div class="form-group" style="grid-column: span 1;">
                                <label for="title">📝 タスク名</label>
                                <input 
                                    type="text" 
                                    name="title" 
                                    id="title" 
                                    value="{{ todo.title }}{% if todo.tags %}{% for tag in todo.tags.split(',') %} #{{ tag.strip() }}{% endfor %}{% endif %}" 
                                    required
                                    placeholder="例：プレゼン資料作成"
                                >
                            </div>
                        </div>

                        <!-- 期限・時間・優先度 -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="due_date">📅 期限日</label>
                                <input 
                                    type="date" 
                                    name="due_date" 
                                    id="due_date"
                                    value="{{ todo.due_date }}"
                                >
                            </div>
                            <div class="form-group">
                                <label for="due_time">⏰ 時間</label>
                                <input 
                                    type="time" 
                                    name="due_time" 
                                    id="due_time"
                                    value="{{ todo.due_time }}"
                                >
                            </div>
                            <div class="form-group">
                                <label for="priority">🎯 優先度</label>
                                <select name="priority" id="priority">
                                    <option value="low" {% if todo.priority == 'low' %}selected{% endif %}>🟡 低</option>
                                    <option value="medium" {% if todo.priority == 'medium' %}selected{% endif %}>🟠 中</option>
                                    <option value="high" {% if todo.priority == 'high' %}selected{% endif %}>🔴 高</option>
                                </select>
                            </div>
                        </div>

                        <!-- 繰り返し設定 -->
                        <div class="form-group">
                            <label style="display: flex; align-items: center; font-weight: 500; cursor: pointer;">
                                <input type="checkbox" id="is_recurring" name="is_recurring" onchange="toggleRecurrenceOptions()" {% if todo.is_recurring %}checked{% endif %}>
                                <span style="margin-left: 10px;">🔄 繰り返しタスク</span>
                            </label>
                        </div>

                        <div id="recurrenceOptions" class="recurrence-options" style="{% if not todo.is_recurring %}display: none;{% endif %}">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="recurrence_type">パターン</label>
                                    <select name="recurrence_type" id="recurrence_type">
                                        <option value="daily" {% if todo.recurrence_type == 'daily' %}selected{% endif %}>📅 毎日</option>
                                        <option value="weekly" {% if todo.recurrence_type == 'weekly' %}selected{% endif %}>📆 毎週</option>
                                        <option value="monthly" {% if todo.recurrence_type == 'monthly' %}selected{% endif %}>📊 毎月</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="recurrence_end_date">終了日</label>
                                    <input
                                        type="date"
                                        name="recurrence_end_date"
                                        id="recurrence_end_date"
                                        value="{{ todo.recurrence_end_date }}"
                                    />
                                </div>
                            </div>
                        </div>

                        <!-- メモ -->
                        <div class="form-group">
                            <label for="memo">💬 メモ</label>
                            <textarea 
                                name="memo" 
                                id="memo"
                                placeholder="追加の説明やメモを記入..."
                            >{{ todo.memo }}</textarea>
                        </div>

                        <!-- 現在のタグ表示 -->
                        {% if todo.tags %}
                        <div style="background-color: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--accent-blue);">
                            <strong style="color: var(--text-primary);">📌 現在のタグ:</strong>
                            <div class="task-tags" style="margin-top: 10px;">
                                {% for tag in todo.tags.split(',') %}
                                {% if tag.strip() %}
                                <span class="tag">#{{ tag.strip() }}</span>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <button type="submit">💾 タスクを更新</button>
                    </form>
                </div>

                <div class="back-link">
                    <a href="{{ url_for('home') }}">← タスク一覧に戻る</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ダークモード初期化
        function initDarkMode() {
          const isDarkMode = localStorage.getItem('darkMode') === 'true';
          if (isDarkMode) {
            document.body.classList.add('dark-mode');
            updateDarkModeButton();
          }
        }

        // ダークモード切り替え
        function toggleDarkMode() {
          document.body.classList.toggle('dark-mode');
          const isDarkMode = document.body.classList.contains('dark-mode');
          localStorage.setItem('darkMode', isDarkMode);
          updateDarkModeButton();
        }

        // ボタン更新
        function updateDarkModeButton() {
          const btn = document.getElementById('darkModeToggle');
          const isDarkMode = document.body.classList.contains('dark-mode');
          btn.textContent = isDarkMode ? '☀️ ライト' : '🌙 ダーク';
        }

        // 繰り返しオプション表示切り替え
        function toggleRecurrenceOptions() {
            const isRecurring = document.getElementById('is_recurring').checked;
            const options = document.getElementById('recurrenceOptions');
            options.style.display = isRecurring ? 'block' : 'none';
        }

        // ページ読み込み時に初期化
        document.addEventListener('DOMContentLoaded', initDarkMode);
    </script>
</body>
</html>