<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã‚¿ã‚¹ã‚¯ç®¡ç† - Todo App</title>
    <link rel="stylesheet" href="../static/style.css" />
  </head>
  <body>
    <div class="container">
      <div class="main-card">
        <!-- ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== -->
        <div class="header-section">
          <div class="header-left">
            <h1>ğŸ“‹ ã‚¿ã‚¹ã‚¯ç®¡ç†</h1>
          </div>
          <div class="header-right">
            <button
              id="darkModeToggle"
              onclick="toggleDarkMode()"
              class="header-button"
            >
              ğŸŒ™ ãƒ€ãƒ¼ã‚¯
            </button>
            <a href="{{ url_for('calendar_view') }}" class="header-button"
              >ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a
            >
            <a href="{{ url_for('logout') }}" class="header-button logout"
              >ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a
            >
          </div>
        </div>

        <!-- ===== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ===== -->
        <div class="main-content">
          <!-- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
          {% with messages = get_flashed_messages() %} {% if messages %}
          <div class="flashes">
            {% for message in messages %}
            <div class="flash-message">{{ message }}</div>
            {% endfor %}
          </div>
          {% endif %} {% endwith %}

          <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
          <div class="search-filter-container">
            <form
              method="GET"
              action="{{ url_for('home') }}"
              class="search-group"
            >
              <input
                type="text"
                name="search"
                placeholder="ğŸ” ã‚¿ã‚¹ã‚¯åã¾ãŸã¯ã‚¿ã‚°ã§æ¤œç´¢..."
                value="{{ search_query }}"
              />
              <button type="submit">æ¤œç´¢</button>
            </form>
            <div class="filter-buttons">
              {% if search_query %}
              <a href="{{ url_for('home') }}" class="filter-button">ãƒªã‚»ãƒƒãƒˆ</a>
              {% endif %}
              <button
                type="button"
                id="toggleCompletedBtn"
                class="filter-button active"
                onclick="toggleCompleted()"
              >
                âœ“ å®Œäº†æ¸ˆã¿è¡¨ç¤º
              </button>
            </div>
          </div>

          <!-- ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
          <div class="add-form">
            <h3>â• æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </h3>
            <form method="POST" action="/add">
              <div class="form-row">
                <div class="form-group" style="grid-column: span 2">
                  <label for="title">ã‚¿ã‚¹ã‚¯å</label>
                  <input
                    type="text"
                    name="title"
                    id="title"
                    placeholder="ä¾‹ï¼šãƒ—ãƒ¬ã‚¼ãƒ³è³‡æ–™ä½œæˆ #ä»•äº‹"
                    required
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="due_date">ğŸ“… æœŸé™æ—¥</label>
                  <input type="date" name="due_date" id="due_date" />
                </div>
                <div class="form-group">
                  <label for="due_time">â° æ™‚é–“</label>
                  <input type="time" name="due_time" id="due_time" />
                </div>
                <div class="form-group">
                  <label for="priority">ğŸ¯ å„ªå…ˆåº¦</label>
                  <select name="priority" id="priority">
                    <option value="low">ğŸŸ¡ ä½</option>
                    <option value="medium" selected>ğŸŸ  ä¸­</option>
                    <option value="high">ğŸ”´ é«˜</option>
                  </select>
                </div>
              </div>

              <!-- ç¹°ã‚Šè¿”ã—è¨­å®š -->
              <div class="form-group">
                <label
                  style="
                    display: flex;
                    align-items: center;
                    font-weight: 500;
                    cursor: pointer;
                  "
                >
                  <input
                    type="checkbox"
                    id="is_recurring"
                    name="is_recurring"
                    onchange="toggleRecurrenceOptions()"
                  />
                  <span style="margin-left: 10px">ğŸ”„ ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯</span>
                </label>
              </div>

              <div
                id="recurrenceOptions"
                class="recurrence-options"
                style="display: none"
              >
                <div class="form-row">
                  <div class="form-group">
                    <label for="recurrence_type">ãƒ‘ã‚¿ãƒ¼ãƒ³</label>
                    <select name="recurrence_type" id="recurrence_type">
                      <option value="daily">ğŸ“… æ¯æ—¥</option>
                      <option value="weekly">ğŸ“† æ¯é€±</option>
                      <option value="monthly">ğŸ“Š æ¯æœˆ</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="recurrence_end_date"
                      >çµ‚äº†æ—¥ï¼ˆç„¡æŒ‡å®šã§ç„¡æœŸé™ï¼‰</label
                    >
                    <input
                      type="date"
                      name="recurrence_end_date"
                      id="recurrence_end_date"
                    />
                  </div>
                </div>
              </div>

              <!-- ãƒ¡ãƒ¢ -->
              <div class="form-group">
                <label for="memo">ğŸ’¬ ãƒ¡ãƒ¢</label>
                <textarea
                  name="memo"
                  id="memo"
                  placeholder="è¿½åŠ ã®èª¬æ˜ã‚„ãƒ¡ãƒ¢ã‚’è¨˜å…¥..."
                ></textarea>
              </div>

              <button type="submit">ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </button>
            </form>
          </div>

          <!-- æœªå®Œäº†ã‚¿ã‚¹ã‚¯ -->
          <div class="task-section">
            <h2>ğŸ“Œ æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯</h2>
            {% set incomplete = todo_list | selectattr('is_done', 'equalto',
            False) | list %} {% if incomplete %}
            <ul>
              {% for todo in incomplete %}
              <li>
                <div class="task-title">
                  <div class="task-meta">
                    <span class="priority-badge priority-{{ todo.priority }}">
                      {% if todo.priority == 'high' %}ğŸ”´ é«˜{% elif todo.priority
                      == 'medium' %}ğŸŸ  ä¸­{% else %}ğŸŸ¡ ä½{% endif %}
                    </span>
                    {% if todo.is_recurring %}
                    <span class="recurring-badge">ğŸ”„ ç¹°ã‚Šè¿”ã—</span>
                    {% endif %} {% if todo.due_date %}
                    <span class="due-date-badge"
                      >ğŸ“… {{ todo.due_date }}{% if todo.due_time %} â° {{
                      todo.due_time }}{% endif %}</span
                    >
                    {% endif %}
                  </div>
                  <div class="task-name">{{ todo.title }}</div>
                  {% if todo.tags %}
                  <div class="task-tags">
                    {% for tag in todo.tags.split(',') %} {% if tag.strip() %}
                    <a
                      href="{{ url_for('home', search='#' + tag.strip()) }}"
                      class="tag"
                      >#{{ tag.strip() }}</a
                    >
                    {% endif %} {% endfor %}
                  </div>
                  {% endif %} {% if todo.memo %}
                  <div class="task-memo">ğŸ’¡ {{ todo.memo }}</div>
                  {% endif %}
                </div>

                <div class="task-actions">
                  <form
                    method="POST"
                    action="/complete/{{ todo.id }}"
                    style="display: inline"
                  >
                    <button type="submit" class="complete-button">
                      âœ“ å®Œäº†
                    </button>
                  </form>
                  <a
                    href="{{ url_for('edit', todo_id=todo.id) }}"
                    class="edit-link"
                    >âœï¸ ç·¨é›†</a
                  >
                  <form
                    method="POST"
                    action="/delete/{{ todo.id }}"
                    style="display: inline"
                  >
                    <button type="submit" class="delete-button">ğŸ—‘ï¸ å‰Šé™¤</button>
                  </form>
                </div>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <div class="no-tasks">âœ¨ ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãŠç–²ã‚Œæ§˜ã§ã™ï¼</div>
            {% endif %}
          </div>

          <!-- å®Œäº†æ¸ˆã¿ã‚¿ã‚¹ã‚¯ -->
          <div class="task-section" id="completedTasksSection">
            <h2>âœ… å®Œäº†æ¸ˆã¿ã‚¿ã‚¹ã‚¯</h2>
            {% set completed = todo_list | selectattr('is_done', 'equalto',
            True) | list %} {% if completed %}
            <ul>
              {% for todo in completed %}
              <li>
                <div class="task-title">
                  <div class="task-meta">
                    <span
                      class="priority-badge priority-{{ todo.priority }}"
                      style="opacity: 0.6"
                    >
                      {% if todo.priority == 'high' %}ğŸ”´ é«˜{% elif todo.priority
                      == 'medium' %}ğŸŸ  ä¸­{% else %}ğŸŸ¡ ä½{% endif %}
                    </span>
                    {% if todo.is_recurring %}
                    <span class="recurring-badge" style="opacity: 0.6"
                      >ğŸ”„ ç¹°ã‚Šè¿”ã—</span
                    >
                    {% endif %} {% if todo.due_date %}
                    <span class="due-date-badge" style="opacity: 0.6"
                      >ğŸ“… {{ todo.due_date }}</span
                    >
                    {% endif %}
                  </div>
                  <div
                    class="task-name"
                    style="text-decoration: line-through; opacity: 0.7"
                  >
                    {{ todo.title }}
                  </div>
                  {% if todo.tags %}
                  <div class="task-tags">
                    {% for tag in todo.tags.split(',') %} {% if tag.strip() %}
                    <a
                      href="{{ url_for('home', search='#' + tag.strip()) }}"
                      class="tag"
                      style="opacity: 0.6"
                      >#{{ tag.strip() }}</a
                    >
                    {% endif %} {% endfor %}
                  </div>
                  {% endif %}
                </div>

                <div class="task-actions">
                  <a
                    href="{{ url_for('edit', todo_id=todo.id) }}"
                    class="edit-link"
                    >âœï¸ ç·¨é›†</a
                  >
                  <form
                    method="POST"
                    action="/delete/{{ todo.id }}"
                    style="display: inline"
                  >
                    <button type="submit" class="delete-button">ğŸ—‘ï¸ å‰Šé™¤</button>
                  </form>
                </div>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <div class="no-tasks">å®Œäº†æ¸ˆã¿ã‚¿ã‚¹ã‚¯ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <script>
      // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–
      function initDarkMode() {
        const isDarkMode = localStorage.getItem("darkMode") === "true";
        if (isDarkMode) {
          document.body.classList.add("dark-mode");
          updateDarkModeButton();
        }
      }

      // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
      function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
        const isDarkMode = document.body.classList.contains("dark-mode");
        localStorage.setItem("darkMode", isDarkMode);
        updateDarkModeButton();
      }

      // ãƒœã‚¿ãƒ³æ›´æ–°
      function updateDarkModeButton() {
        const btn = document.getElementById("darkModeToggle");
        const isDarkMode = document.body.classList.contains("dark-mode");
        btn.textContent = isDarkMode ? "â˜€ï¸ ãƒ©ã‚¤ãƒˆ" : "ğŸŒ™ ãƒ€ãƒ¼ã‚¯";
      }

      // å®Œäº†æ¸ˆã¿ã‚¿ã‚¹ã‚¯è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      let showCompleted = localStorage
        ? localStorage.getItem("showCompleted") !== "false"
        : true;

      function toggleCompleted() {
        showCompleted = !showCompleted;
        if (localStorage) {
          localStorage.setItem("showCompleted", showCompleted);
        }
        updateCompletedVisibility();
      }

      function updateCompletedVisibility() {
        const section = document.getElementById("completedTasksSection");
        const btn = document.getElementById("toggleCompletedBtn");

        if (showCompleted) {
          section.style.display = "block";
          btn.classList.add("active");
          btn.textContent = "âœ“ å®Œäº†æ¸ˆã¿è¡¨ç¤º";
        } else {
          section.style.display = "none";
          btn.classList.remove("active");
          btn.textContent = "âœ“ å®Œäº†æ¸ˆã¿éè¡¨ç¤º";
        }
      }

      // ç¹°ã‚Šè¿”ã—ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
      function toggleRecurrenceOptions() {
        const isRecurring = document.getElementById("is_recurring").checked;
        const options = document.getElementById("recurrenceOptions");
        options.style.display = isRecurring ? "block" : "none";
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
      document.addEventListener("DOMContentLoaded", function () {
        initDarkMode();
        updateCompletedVisibility();
      });
    </script>
  </body>
</html>
